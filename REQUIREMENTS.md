# RISE比較表作成プロンプト

## 目的
東急リバブルの公式HPから「二子玉川ライズ」の中古マンション（65㎡〜80㎡未満）を抽出し、比較表を作成する。

## 物件検出方法

### 自動検出モード（v3）デフォルト

**幅優先探索（BFS）**により、二子玉川ライズの全物件を自動的に発見します。

#### シード物件（起点となる物件）
各棟から1件ずつ：
1. https://www.livable.co.jp/mansion/C13252K32/ （イースト）
2. https://www.livable.co.jp/mansion/C48258711/ （ウエスト）
3. https://www.livable.co.jp/mansion/C13259K25/ （セントラル）

#### 検出アルゴリズム
1. シード物件のページにアクセス
2. 「同じ建物の他の物件」セクションから関連物件のリンクを抽出
3. 未訪問の物件をキューに追加
4. すべての物件を発見するまで繰り返す（幅優先探索）
5. 面積フィルタ（65㎡〜80㎡）を適用
6. 条件に合う物件のみをリストアップ

#### 実装結果（2025年10月7日時点）
- **発見した全物件**: 9件
- **条件に合致（65㎡〜80㎡）**: 7件
- **範囲外で除外**: 2件（85.41㎡、84.02㎡）

**メリット:**
- 新規物件の自動検出
- 手動でのURL管理が不要
- 販売終了物件の自動除外
- 常に最新のデータを維持

### 手動指定モード

`AUTO_DISCOVER = False`に設定した場合、以下の物件のみを対象とします：

1. https://www.livable.co.jp/mansion/C13252K32/
2. https://www.livable.co.jp/mansion/C48258711/
3. https://www.livable.co.jp/mansion/C1325X119/
4. https://www.livable.co.jp/mansion/C13259K25/
5. https://www.livable.co.jp/mansion/CV623ZG20/
6. https://www.livable.co.jp/mansion/C48259B69/

## 抽出条件

- **サイト**: https://www.livable.co.jp/
- **対象**: 「二子玉川ライズ」関連の中古マンション
- **面積**: 65㎡以上〜80㎡未満
- **抽出件数**: 上記6件（固定）

## 抽出情報

各物件について以下の情報を取得：

1. 管理番号（URL末尾のID）
2. 販売価格（買主から見た実際の支払価格。法人売主＝税込価格、個人売主＝非課税表示価格）
3. 平米単価（販売価格 ÷ 専有面積）
4. 坪単価（販売価格 ÷ (専有面積 ÷ 3.3)）
5. 間取り
6. 専有面積
7. 棟名（イースト／ウエスト／セントラルのみ）
8. 階数
9. 築年月
10. 向き
11. リフォーム有無
12. お気に入り登録数（「◯件 お気に入り」形式で表示される数値）
13. 担当者（ページ最下部「お問合せ先」に記載の実名）

## 出力フォーマット

### 比較表（Markdown形式）

**列の順序**:  
管理番号 → 販売価格 → 平米単価 → 坪単価 → 間取り → 専有面積 → 棟名 → 階数 → 築年月 → 向き → リフォーム → お気に入り → 担当者

**並び順**: 平米単価の安い順

### 単位指定

- **販売価格**: 〇〇万円（「万円」単位）
- **平米単価**: 〇〇.xx万円/㎡（小数点2桁まで）
- **坪単価**: 〇〇.x万円/坪（小数点1桁まで）
- **専有面積**: 〇〇.xx㎡（小数点2桁まで）
- **階数**: 例「17/42」
- **築年月**: 例「2010年5月」
- **リフォーム**: 「有」「無」のみ（「予定」などの補足は不要）

## 注意点

- 販売価格は「税込統一価格」ではなく、買主から見た実際の支払価格として「販売価格」と表記する
- 平米単価・坪単価は必ず「販売価格」を基準に計算する
- 担当者は「お問合せ先」欄に記載の名前を反映する
- リフォーム欄には「有」「無」のみ記載し、「(予定)」などの補足は記載しない

## 出力形式

### 1. Markdown形式（latest.md）
標準的なMarkdown形式で出力し、テキストエディタやGitHubで閲覧可能

### 2. HTML形式（viewer.html）
ブラウザーで表示するためのスタイリッシュなビジュアル形式

## 出力に含める内容

1. 比較表（Markdown形式）
2. 物件リンク一覧
3. 問い合わせ先情報

物件リンク一覧のフォーマット：

## 二子玉川ライズ 中古マンション物件一覧（65㎡～80㎡未満）

1. **C13252K32** - イースト 17階 2LDK 70.32㎡  
   https://www.livable.co.jp/mansion/C13252K32/

2. **C48258711** - ウエスト 27階 2LDK 67.51㎡  
   https://www.livable.co.jp/mansion/C48258711/

3. **C1325X119** - イースト 16階 2LDK 73.62㎡  
   https://www.livable.co.jp/mansion/C1325X119/

4. **C13259K25** - セントラル 5階 3LDK 76.59㎡  
   https://www.livable.co.jp/mansion/C13259K25/

5. **CV623ZG20** - イースト 36階 2LDK 76.40㎡  
   https://www.livable.co.jp/mansion/CV623ZG20/

6. **C48259B69** - ウエスト 16階 2LDK 70.74㎡  
   https://www.livable.co.jp/mansion/C48259B69/

---

**問い合わせ先:**  
東急リバブル 二子玉川センター  
TEL: 0120-938-291（無料）  
営業時間: 10:00～18:00  
定休日: 毎週火曜日・水曜日

## 変更検出機能（v4で実装済み）

毎回の実行時に、前回データとの差分を自動的に検出し、変更レポートを生成します。

### 実装方式: JSON履歴保存

#### データ保存
- **price_tracker.json**: 全物件の価格履歴を保存
- **history/YYYY-MM-DD.json**: 日次スナップショット
- **changes_YYYYMMDD.md**: 日次変更レポート

#### 追跡される情報
各物件ごとに以下を記録：
- 価格履歴（日付ごと）
- 初出日・初出価格
- 最高値・最安値
- 累計変動額・変動率
- 建物情報（棟名、階数、間取り、担当者）

### 自動検出される変更

前回データと比較して、以下の形式で変更箇所を報告：

### 変更検出レポート（YYYY年MM月DD日）

#### 価格変更
| 管理番号 | 物件 | Before | After | 変動額 | 変動率 |
|---|---|---|---|---|---|

#### リフォーム状況変更
| 管理番号 | 物件 | Before | After |
|---|---|---|---|

#### 担当者変更
| 管理番号 | 物件 | Before | After |
|---|---|---|---|

#### 新規追加物件
| 管理番号 | 販売価格 | 専有面積 | 棟名 | 階数 |
|---|---|---|---|---|

#### 販売終了物件
| 管理番号 | 物件 | 最終価格 |
|---|---|---|

## HTMLビューアー機能（viewer.html）

### 概要
ブラウザーで比較表を美しく表示するためのインタラクティブなHTMLビューアー

### デザインコンセプト
- **シンプル**: 余計な装飾を排除したクリーンなレイアウト（絵文字不使用）
- **スタイリッシュ**: モダンなグラデーションとシャドウ効果
- **読みやすさ**: 適切なコントラストと文字サイズ
- **直感的**: 重要な情報が一目でわかる配色（坪単価・販売価格を強調）

### 主要機能

#### 1. ダークモード対応
- ライトモード/ダークモード切替ボタン
- 設定はブラウザーのローカルストレージに自動保存
- 目に優しい色使い

#### 2. ランキング表示
- 平米単価の安い順に順位を表示
- テーブル内の文字サイズは均等（0.95rem）
- 順位は参考情報として控えめに表示（メダル表示なし）
- 安さの順位は絶対的な評価ではないため、装飾的な強調は避ける

#### 3. カラーバッジシステム
- **棟名バッジ**: 
  - イースト: ブルー系
  - ウエスト: ピンク系
  - セントラル: グリーン系
- **リフォームバッジ**:
  - 有: グリーン系
  - 無: レッド系

#### 4. インタラクティブ要素
- テーブル行のホバーエフェクト（拡大・影表示）
- 物件リンクへのスムーズな遷移アニメーション
- クリックで公式サイトへ直接アクセス

#### 5. レスポンシブデザイン
- デスクトップ、タブレット、スマートフォンに対応
- 小画面では横スクロール可能なテーブル表示
- 画面サイズに応じた最適なレイアウト

#### 6. アニメーション効果
- ページロード時のフェードイン
- 要素の滑らかな表示
- ホバー時の動的エフェクト

### 表示要素

#### ヘッダー
- タイトル: 「二子玉川ライズ 中古マンション比較表」（グラデーションテキスト、絵文字なし）
- 作成日時と自動検出件数
- テーマ切替ボタン

#### 比較表
- 順位付き物件一覧
- 12項目の詳細情報
- 平米単価でソート済み

#### フォントスタイル仕様
比較表内の各項目のスタイル設定：

| 項目 | フォントサイズ | フォントウェイト | カラー | 備考 |
|---|---|---|---|---|
| 順位 | 0.95rem | 600 | グレー | 控えめな表示 |
| 管理番号 | 0.95rem | 400 | 黒 | モノスペースフォント |
| 販売価格 | 0.95rem | 700 | 黒 | **太字で強調** |
| 平米単価 | 0.95rem | 400 | 黒 | 通常表示 |
| 坪単価 | 0.95rem | 700 | ブルー | **太字＋色で強調** |
| その他 | 0.95rem | 400 | 黒 | 通常表示 |

**強調項目の理由:**
- **販売価格**: 最も重要な比較要素のため太字
- **坪単価**: 日本の不動産で一般的な単位で、比較しやすいため太字＋色で強調

#### 物件リンク一覧
- 各物件への直リンク
- 物件概要の表示
- ホバーエフェクト付き

#### 問い合わせ先情報
- 店舗名、電話番号、営業時間
- グラデーション背景で目立つデザイン

### 技術仕様
- 純粋なHTML/CSS/JavaScript（フレームワーク不要）
- モダンブラウザー対応
- オフラインでも動作可能
- 印刷にも対応したスタイル

### 使用方法
```bash
# ブラウザーで開く
open viewer.html

# または
double-click viewer.html
```

### カスタマイズ
HTMLファイルを直接編集することで、以下をカスタマイズ可能：
- 配色テーマ
- フォントサイズ
- アニメーション速度
- 表示項目

## 技術的な実装上の注意点

### データ抽出時の課題と対処法

実装時に判明したWebサイトの構造と対処方法を以下に記録。次回の実装や保守時に参照。

#### 1. HTML構造
**課題**: テーブル（`<table>`）構造ではなく、定義リスト（`<dl>/<dt>/<dd>`）構造を使用  
**対処法**: `find_dl_value()` 関数を作成し、キーワードで `<dt>` を検索して対応する `<dd>` の値を取得

```python
def find_dl_value(soup: BeautifulSoup, keyword: str) -> Optional[str]:
    dt_elem = soup.find('dt', string=re.compile(keyword, re.IGNORECASE))
    if dt_elem:
        dd_elem = dt_elem.find_next_sibling('dd')
        if dd_elem:
            return dd_elem.get_text(strip=True)
    return None
```

#### 2. 価格表示の複雑性
**課題**: 価格が「1億5,800万円」のように億円単位を含む場合がある  
**対処法**: 億円の有無を判定し、分岐処理で計算

```python
if '億' in price_value:
    oku_match = re.search(r'(\d+)億([\d,]+)?万円', price_value)
    if oku_match:
        oku = int(oku_match.group(1)) * 10000
        man = int(oku_match.group(2).replace(',', '')) if oku_match.group(2) else 0
        property_data['price'] = oku + man
```

**注意**: 「1億万円」のような表記では万円部分がNoneになるため、条件分岐が必須

#### 3. 階数フィールド名
**課題**: フィールド名が「所在階」ではなく「所在階数」  
**対処法**: 正規表現で複数パターンに対応

```python
floor_value = find_dl_value(soup, r'所在階数|所在階')
```

**抽出パターン**: 「17階 / 地上42階 地下1階」 → 「17/42」  
正規表現: `r'(\d+)階.*?地上(\d+)階'`

#### 4. 専有面積の表記
**課題**: 「壁芯70.32m²」のように単位が「m」と「²」に分かれている  
**対処法**: 正規表現で「m」の前の数値を抽出

```python
area_match = re.search(r'([\d.]+)\s*m', area_value)
```

#### 5. リフォーム情報の取得
**課題**: リフォーム情報が必ずしも明示的に記載されていない  
**対処法**: 複数箇所（リフォーム欄、設備・条件欄、備考欄）を確認し、デフォルトは「無」

```python
reform_value = find_dl_value(soup, r'リフォーム|リノベーション')
equipment_value = find_dl_value(soup, r'設備・条件')
remarks_value = find_dl_value(soup, r'備考')

property_data['reform'] = '無'  # デフォルト
for value in [reform_value, equipment_value, remarks_value]:
    if value and ('リフォーム' in value or 'リノベーション' in value):
        if '済' in value or '有' in value:
            property_data['reform'] = '有'
            break
```

#### 6. 担当者名の取得
**課題**: 担当者名の配置場所が不明確  
**対処法**: 複数の方法で探索

1. 「私が担当いたします：」というテキストの次の `<p>` 要素
2. `class` に「contact-person__name」を含む要素
3. ローマ字読み（かな）を除外するフィルタリング

```python
# 方法1
contact_section = soup.find('p', string=re.compile(r'私が担当'))
if contact_section:
    staff_elem = contact_section.find_next('p')

# 方法2（フォールバック）
staff_elems = soup.find_all('p', class_=re.compile('contact-person__name'))
for elem in staff_elems:
    text = elem.get_text(strip=True)
    if text and not re.match(r'^[a-zA-Z]+$', text):  # ローマ字を除外
        property_data['staff'] = text
        break
```

#### 7. 棟名の抽出
**課題**: 棟名が所在地に含まれる場合と建物名に含まれる場合がある  
**対処法**: 
1. まず「所在地」から抽出を試みる
2. 取得できない場合は `<h1>` タイトルから抽出

```python
location_value = find_dl_value(soup, r'所在地')
if location_value:
    if 'イースト' in location_value:
        property_data['building'] = 'イースト'
    # ... 他の棟名も同様

# フォールバック
if 'building' not in property_data:
    title = soup.find('h1')
    if title:
        title_text = title.get_text()
        if 'イースト' in title_text:
            property_data['building'] = 'イースト'
```

#### 8. お気に入り数の抽出
**課題**: お気に入り数の表示場所が特定しにくい  
**対処法**: 3段階のフォールバック戦略

1. パターン1: 「◯件 お気に入り」というテキストを検索
2. パターン2: class名に「favorite」や「like」を含む要素を探す
3. パターン3: ページ全体から正規表現で抽出

```python
# パターン1
favorite_text = soup.find(string=re.compile(r'件\s*お気に入り'))
if favorite_text:
    parent_text = favorite_text.parent.get_text(strip=True)
    count_match = re.search(r'(\d+)\s*件\s*お気に入り', parent_text)
    if count_match:
        favorite_count = int(count_match.group(1))

# パターン2, 3も同様に実装
property_data['favorite_count'] = favorite_count if favorite_count is not None else 0
```

**注意**: 
- キー名は `favorite_count` で統一（`favorites` ではない）
- 取得できない場合は `0` として扱う
- HTMLビューアーでは `0` の場合は `-` と表示

### レート制限への配慮
**実装内容**: 物件間で1秒の待機時間（`time.sleep(1)`）を設定  
**理由**: サーバーへの負荷軽減とアクセス制限回避

### エラーハンドリング
- 各物件の取得は独立して処理
- エラーが発生しても他の物件の取得は継続
- エラー情報は別セクションに表示

### 今後の保守における注意点
1. Webサイトの構造変更に備え、定期的な動作確認が必要
2. フィールド名の変更（例：「所在階数」→「階数」）に注意
3. 新しい価格表記（例：千万円単位）が登場する可能性
4. リフォーム情報の記載方法が変更される可能性

## 自動更新設定（GitHub Actions）

### 概要
GitHub Actionsを使用して、毎日自動的にデータ更新を実行します。

### 実行スケジュール
- **毎日 午前9時（日本時間）**
- UTC 0:00（cron: '0 0 * * *'）

### 実行内容
1. 物件自動検出（BFS）
2. データ取得・面積フィルタ
3. 価格変更検出
4. HTMLとMarkdownの生成
5. GitHubに自動commit & push
6. Vercelが自動デプロイ

### メリット
- ✅ Macの起動不要
- ✅ 完全自動化
- ✅ 実行ログがGitHub上で確認可能
- ✅ 手動実行も可能
- ✅ 無料（GitHub Actionsの無料枠で十分）

### ファイル
- `.github/workflows/daily-update.yml`

---

## 更新履歴

### v4 (2025年10月8日)
**価格変遷追跡機能の実装**
- 全履歴保存によるJSON方式の実装
- 日付ごとの価格履歴を記録（price_tracker.json）
- 日次スナップショット保存（history/YYYY-MM-DD.json）
- 4種類の変更検出（価格変更、新規物件、販売終了、担当者変更）
- 自動変更レポート生成（changes_YYYYMMDD.md）
- 初出価格・最高値・最安値・累計変動額を自動計算

**HTML自動生成機能の実装**
- `html_generator.py`モジュールの追加
- スクリプト実行時に`index.html`を自動更新
- タイムスタンプ、物件件数、お気に入り数を動的に反映
- 手動でHTMLを編集する必要がなくなった

**お気に入り数の取得**
- 物件ページから「◯件 お気に入り」を自動抽出
- 3つのパターンで探索（テキスト検索、クラス名検索、全体検索）
- 比較表とHTMLビューアーの両方に表示

**メリット:**
- 販売価格の変遷を完全に追跡可能
- 新規物件の自動検出
- 「いつ」「いくら」値下げがあったか履歴で確認可能
- 実行のたびに最新データでHTMLが自動更新
- 将来的にグラフ化も可能

### v3 (2025年10月7日)
**物件自動検出機能の実装**
- 幅優先探索（BFS）による全物件自動発見
- 面積フィルタリング（65㎡〜80㎡）の実装
- シード物件から自動的に関連物件を辿る機能
- 手動指定モードとの切替機能
- 7件の物件を自動検出（従来の6件から+1件）

**HTMLビューアーのスタイル改善**
- メダル表示を削除（順位は参考情報として控えめに表示）
- タイトルから絵文字を削除（シンプルなデザイン）
- 坪単価を太字＋青色で強調表示
- 販売価格を太字で強調表示
- テーブル内のフォントサイズを0.95remに統一
- 管理番号、平米単価を通常表示（黒色、標準フォントウェイト）

**理由:**
- 価格の安さだけが物件の価値ではないため、メダル表示は不適切
- 坪単価は日本の不動産で一般的な単位のため重視
- 視覚的な情報の優先順位を明確化
- 絵文字は装飾的で本質的な情報ではないため削除（シンプルなデザイン志向）

### v2 (2025年10月6日)
**初版リリース**
- 6件の物件情報取得機能
- dl/dt/dd構造への対応
- 億円単位の価格表示への対応
- Markdown形式での比較表生成
- 平米単価順ソート機能
- HTMLビューアーの実装
- ダークモード対応
- レスポンシブデザイン

